import pandas as pd
import numpy as np
from tensorflow.keras.models import Model
from tensorflow.keras.layers import Input, Dense
from sklearn.preprocessing import StandardScaler
from sklearn.metrics import confusion_matrix

# Load dataset
df = pd.read_csv("C:\\Users\\Sanath\\Downloads\\creditcard.csv")

# Prepare data
X = df.drop("Class", axis=1)
y = df["Class"]

scaler = StandardScaler()
X_scaled = scaler.fit_transform(X)

# Train only on normal transactions
X_train = X_scaled[y == 0]
X_test = X_scaled

# Build Autoencoder
input_dim = X_train.shape[1]
input_img = Input(shape=(input_dim,))
encoded = Dense(16, activation="relu")(input_img)
decoded = Dense(input_dim, activation="sigmoid")(encoded)
autoencoder = Model(input_img, decoded)
autoencoder.compile(optimizer="adam", loss="mse")

# Train
autoencoder.fit(X_train, X_train, epochs=10, batch_size=32, shuffle=True)

# Reconstruction
reconstructed = autoencoder.predict(X_test)
mse = np.mean(np.power(X_test - reconstructed, 2), axis=1)
threshold = np.mean(mse) + np.std(mse)
df["Predicted_Class"] = (mse > threshold).astype(int)

print("Threshold:", threshold)
print(df[["Class", "Predicted_Class"]].head(10))

# âœ… Confusion Matrix
cm = confusion_matrix(df["Class"], df["Predicted_Class"])
print("\nConfusion Matrix:")
print(cm)
